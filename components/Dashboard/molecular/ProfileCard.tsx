import { useContext, useEffect, useRef, useState } from 'react';
import { PopupModal } from './PopupModal';
import { sessionContext } from '../_contexts/sessionContext';
import type { Profile } from '@/types/accounts/user';

interface ProfileCardType {
	logoutFn: () => void;
	profileDetsFn: () => void;
	closeCardFn: (a: boolean) => void;
	showMyProfile?: boolean;
}

const ProfileCard = (props: ProfileCardType) => {
	const { profileDetsFn, closeCardFn, logoutFn, showMyProfile } = props;

	const [logoutPrompt, setLogoutPrompt] = useState(false);
	// const [showMyProf, setShowMyProf] = useState(false);
	const [userProfile, setUserProfile] = useState<Profile | undefined>(undefined);

	const profileCardRef = useRef<HTMLDivElement | null>(null);
	const userData = useRef(useContext(sessionContext));

	if (userData.current) {
		setUserProfile(userData.current.profile);
	}

	useEffect(() => {
		const profileCardNode = profileCardRef.current!;
		function handler(e: MouseEvent) {
			if (e.target instanceof Node && !profileCardNode.contains(e.target)) {
				closeCardFn(false);
			}
		}

		window.addEventListener('mouseup', handler);
		return () => window.removeEventListener('mouseup', handler);
    }, [closeCardFn] );
    

	return (
		<>
			<div
				ref={profileCardRef}
				className='top-nav-card absolute w-[290px] right-0 bg-white z-50'>
				<div className='py-[12px] px-[16px] paragraph2Medium'>
					{userProfile?.user_name || ''}
				</div>
				{showMyProfile && (
					<button
						className='ami paragraph2Medium text-left w-full'
						onClick={() => {
							profileDetsFn();
							closeCardFn(false);
						}}>
						{/*user icon*/}
						<svg
							width='16'
							height='16'
							viewBox='0 0 16 16'
							fill='none'
							xmlns='http://www.w3.org/2000/svg'>
							<path
								d='M10.4724 8.47325C11.1259 7.95903 11.603 7.25387 11.8372 6.45588C12.0713 5.6579 12.051 4.80676 11.7789 4.0209C11.5068 3.23503 10.9965 2.55352 10.3191 2.07116C9.64161 1.5888 8.83066 1.32959 7.99902 1.32959C7.16739 1.32959 6.35643 1.5888 5.67897 2.07116C5.00152 2.55352 4.49125 3.23503 4.21916 4.0209C3.94707 4.80676 3.9267 5.6579 4.16086 6.45588C4.39503 7.25387 4.87209 7.95903 5.52569 8.47325C4.40574 8.92195 3.42855 9.66615 2.69828 10.6265C1.96802 11.5869 1.51206 12.7275 1.37902 13.9266C1.36939 14.0141 1.3771 14.1027 1.4017 14.1873C1.42631 14.2719 1.46733 14.3508 1.52243 14.4195C1.6337 14.5582 1.79554 14.6471 1.97235 14.6666C2.14917 14.686 2.32646 14.6345 2.46524 14.5232C2.60401 14.4119 2.69291 14.2501 2.71235 14.0733C2.85874 12.77 3.48015 11.5665 4.45783 10.6924C5.43552 9.81844 6.70095 9.33527 8.01236 9.33527C9.32376 9.33527 10.5892 9.81844 11.5669 10.6924C12.5446 11.5665 13.166 12.77 13.3124 14.0733C13.3305 14.2371 13.4086 14.3884 13.5318 14.4979C13.6549 14.6075 13.8142 14.6676 13.979 14.6666H14.0524C14.2271 14.6465 14.3868 14.5581 14.4967 14.4208C14.6066 14.2834 14.6578 14.1082 14.639 13.9333C14.5054 12.7307 14.0469 11.5872 13.3129 10.6254C12.5789 9.66354 11.597 8.91957 10.4724 8.47325ZM7.99902 7.99992C7.4716 7.99992 6.95603 7.84352 6.5175 7.55051C6.07897 7.25749 5.73718 6.84101 5.53534 6.35374C5.33351 5.86647 5.2807 5.3303 5.38359 4.81301C5.48649 4.29573 5.74046 3.82058 6.1134 3.44764C6.48634 3.0747 6.9615 2.82072 7.47878 2.71783C7.99606 2.61493 8.53224 2.66774 9.01951 2.86958C9.50678 3.07141 9.92326 3.4132 10.2163 3.85173C10.5093 4.29026 10.6657 4.80584 10.6657 5.33325C10.6657 6.0405 10.3847 6.71878 9.88464 7.21887C9.38454 7.71897 8.70627 7.99992 7.99902 7.99992Z'
								fill='#070B12'
							/>
						</svg>
						<p className='w-[194px]'>My Profile</p>
						{/*angle right*/}
						<svg
							width='16'
							height='16'
							viewBox='0 0 16 16'
							fill='none'
							xmlns='http://www.w3.org/2000/svg'>
							<path
								d='M10.3592 7.52685L6.58584 3.76019C6.52387 3.6977 6.45013 3.64811 6.36889 3.61426C6.28765 3.58041 6.20052 3.56299 6.11251 3.56299C6.0245 3.56299 5.93736 3.58041 5.85612 3.61426C5.77488 3.64811 5.70115 3.6977 5.63917 3.76019C5.51501 3.8851 5.44531 4.05406 5.44531 4.23019C5.44531 4.40631 5.51501 4.57528 5.63917 4.70019L8.93917 8.03352L5.63917 11.3335C5.51501 11.4584 5.44531 11.6274 5.44531 11.8035C5.44531 11.9796 5.51501 12.1486 5.63917 12.2735C5.70092 12.3365 5.77455 12.3866 5.8558 12.421C5.93705 12.4553 6.0243 12.4732 6.11251 12.4735C6.20071 12.4732 6.28797 12.4553 6.36922 12.421C6.45047 12.3866 6.5241 12.3365 6.58584 12.2735L10.3592 8.50685C10.4268 8.44443 10.4808 8.36866 10.5178 8.28432C10.5547 8.19999 10.5738 8.10892 10.5738 8.01685C10.5738 7.92479 10.5547 7.83372 10.5178 7.74938C10.4808 7.66505 10.4268 7.58928 10.3592 7.52685Z'
								fill='#A4BBDD'
							/>
						</svg>
					</button>
				)}
				<button
					className='ami paragraph2Medium text-left w-full'
					onClick={() => {
						setLogoutPrompt(true);
					}}>
					{/*logout icon*/}
					<svg
						width='16'
						height='16'
						viewBox='0 0 16 16'
						fill='none'
						xmlns='http://www.w3.org/2000/svg'>
						<path
							d='M2.66406 8.00016C2.66406 8.17697 2.7343 8.34654 2.85932 8.47157C2.98435 8.59659 3.15392 8.66683 3.33073 8.66683H8.39073L6.8574 10.1935C6.79491 10.2555 6.74531 10.3292 6.71147 10.4104C6.67762 10.4917 6.6602 10.5788 6.6602 10.6668C6.6602 10.7548 6.67762 10.842 6.71147 10.9232C6.74531 11.0045 6.79491 11.0782 6.8574 11.1402C6.91937 11.2026 6.99311 11.2522 7.07434 11.2861C7.15558 11.3199 7.24272 11.3374 7.33073 11.3374C7.41874 11.3374 7.50587 11.3199 7.58711 11.2861C7.66835 11.2522 7.74209 11.2026 7.80406 11.1402L10.4707 8.4735C10.5314 8.41009 10.579 8.33533 10.6107 8.2535C10.6774 8.09119 10.6774 7.90914 10.6107 7.74683C10.579 7.66499 10.5314 7.59023 10.4707 7.52683L7.80406 4.86016C7.7419 4.798 7.66811 4.7487 7.5869 4.71506C7.50568 4.68142 7.41864 4.6641 7.33073 4.6641C7.24282 4.6641 7.15578 4.68142 7.07456 4.71506C6.99335 4.7487 6.91956 4.798 6.8574 4.86016C6.79524 4.92232 6.74593 4.99611 6.71229 5.07733C6.67865 5.15854 6.66133 5.24559 6.66133 5.3335C6.66134 5.4214 6.67865 5.50845 6.71229 5.58966C6.74593 5.67088 6.79524 5.74467 6.8574 5.80683L8.39073 7.3335H3.33073C3.15392 7.3335 2.98435 7.40373 2.85932 7.52876C2.7343 7.65378 2.66406 7.82335 2.66406 8.00016ZM11.3307 1.3335H4.66406C4.13363 1.3335 3.62492 1.54421 3.24985 1.91928C2.87478 2.29436 2.66406 2.80306 2.66406 3.3335V5.3335C2.66406 5.51031 2.7343 5.67988 2.85932 5.8049C2.98435 5.92992 3.15392 6.00016 3.33073 6.00016C3.50754 6.00016 3.67711 5.92992 3.80213 5.8049C3.92716 5.67988 3.9974 5.51031 3.9974 5.3335V3.3335C3.9974 3.15668 4.06763 2.98712 4.19266 2.86209C4.31768 2.73707 4.48725 2.66683 4.66406 2.66683H11.3307C11.5075 2.66683 11.6771 2.73707 11.8021 2.86209C11.9272 2.98712 11.9974 3.15668 11.9974 3.3335V12.6668C11.9974 12.8436 11.9272 13.0132 11.8021 13.1382C11.6771 13.2633 11.5075 13.3335 11.3307 13.3335H4.66406C4.48725 13.3335 4.31768 13.2633 4.19266 13.1382C4.06763 13.0132 3.9974 12.8436 3.9974 12.6668V10.6668C3.9974 10.49 3.92716 10.3204 3.80213 10.1954C3.67711 10.0704 3.50754 10.0002 3.33073 10.0002C3.15392 10.0002 2.98435 10.0704 2.85932 10.1954C2.7343 10.3204 2.66406 10.49 2.66406 10.6668V12.6668C2.66406 13.1973 2.87478 13.706 3.24985 14.081C3.62492 14.4561 4.13363 14.6668 4.66406 14.6668H11.3307C11.8612 14.6668 12.3699 14.4561 12.7449 14.081C13.12 13.706 13.3307 13.1973 13.3307 12.6668V3.3335C13.3307 2.80306 13.12 2.29436 12.7449 1.91928C12.3699 1.54421 11.8612 1.3335 11.3307 1.3335Z'
							fill='#070B12'
						/>
					</svg>
					<p className='w-[194px]'>Sign Out</p>
					{/*angle right*/}
					<svg
						width='16'
						height='16'
						viewBox='0 0 16 16'
						fill='none'
						xmlns='http://www.w3.org/2000/svg'>
						<path
							d='M10.3592 7.52685L6.58584 3.76019C6.52387 3.6977 6.45013 3.64811 6.36889 3.61426C6.28765 3.58041 6.20052 3.56299 6.11251 3.56299C6.0245 3.56299 5.93736 3.58041 5.85612 3.61426C5.77488 3.64811 5.70115 3.6977 5.63917 3.76019C5.51501 3.8851 5.44531 4.05406 5.44531 4.23019C5.44531 4.40631 5.51501 4.57528 5.63917 4.70019L8.93917 8.03352L5.63917 11.3335C5.51501 11.4584 5.44531 11.6274 5.44531 11.8035C5.44531 11.9796 5.51501 12.1486 5.63917 12.2735C5.70092 12.3365 5.77455 12.3866 5.8558 12.421C5.93705 12.4553 6.0243 12.4732 6.11251 12.4735C6.20071 12.4732 6.28797 12.4553 6.36922 12.421C6.45047 12.3866 6.5241 12.3365 6.58584 12.2735L10.3592 8.50685C10.4268 8.44443 10.4808 8.36866 10.5178 8.28432C10.5547 8.19999 10.5738 8.10892 10.5738 8.01685C10.5738 7.92479 10.5547 7.83372 10.5178 7.74938C10.4808 7.66505 10.4268 7.58928 10.3592 7.52685Z'
							fill='#A4BBDD'
						/>
					</svg>
				</button>
			</div>
			<PopupModal
				showModal={logoutPrompt}
				title='Log Out'
				content='Are you sure you want to log out?'
				primaryAction={logoutFn}
				primaryBtnText='Log Out'
				secondaryBtnText='Cancel'
				secondaryAction={() => {
					setLogoutPrompt(false);
				}}
				closeFxn={() => {
					setLogoutPrompt(false);
				}}
			/>
		</>
	);
};

export { ProfileCard };
